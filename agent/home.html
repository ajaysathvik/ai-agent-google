<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cultural Context Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=S√∂hne:wght@300;400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link rel="stylesheet" href="/style.css">
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: MAIN CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-main">

  <nav class="nav">
    <div class="nav-left">
        <span style="font-size:14px; font-weight:600; color:#0d0d0d;">Cultural Context Agent</span>
    </div>
  </nav>

  <div class="main-content" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: calc(100vh - 52px);">
    <button class="mic-btn-main" onclick="goTo('screen-voice'); document.getElementById('voice-button').click();">
      <svg viewBox="0 0 28 28" fill="white" style="width: 32px; height: 32px;">
        <path d="M14 0 L16.5 9.5 L24 6 L18.5 13.5 L28 14 L18.5 16.5 L24 22 L16.5 18.5 L14 28 L11.5 18.5 L4 22 L9.5 16.5 L0 14 L9.5 13.5 L4 6 L11.5 9.5 Z"/>
      </svg>
    </button>
    <button id="voice-button" style="display:none;"></button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: VOICE MODE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-voice">

  <div class="voice-nav">
    <div class="voice-nav-right">
      <button class="v-icon-btn" onclick="startNewSession()" title="New Session">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M23 4v6h-6"/>
          <path d="M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
      </button>
      <button class="v-icon-btn" onclick="showModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"/>
          <path d="M12 8v4M12 16h.01"/>
        </svg>
      </button>
      <button class="v-icon-btn" onclick="goTo('screen-voice-select')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="12" cy="8" r="4"/>
          <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="voice-main" id="voiceMain">
    <div class="orb-container">
      <div class="orb-ring"></div>
      <div class="orb-ring"></div>
      <div class="orb-ring"></div>
      <div class="orb listening" id="mainOrb"></div>
    </div>

    <!-- Video preview (shown when camera is active) -->
    <div class="video-preview-container" id="videoPreview">
      <video id="voiceCameraVideo" autoplay playsinline muted></video>
    </div>

    <div class="transcript-container" id="transcriptContainer">
      <div class="transcript-content" id="transcriptContent"></div>
    </div>

    <div class="access-hint">
      <span>Enable microphone access in</span>
      <a class="access-link" onclick="showModal()">Settings</a>
      <div class="hint-icon">?</div>
    </div>
  </div>

  <div class="voice-controls">
    <div class="ended-toast">
      <span class="toast-icon">üéô</span>
      <span>Voice chat ended</span>
      <span style="font-size:11px;color:#aaa;margin-left:2px">00:12</span>
      <div class="toast-actions">
        <button class="toast-btn" title="Thumbs up">üëç</button>
        <button class="toast-btn" title="Thumbs down">üëé</button>
        <button class="toast-btn" onclick="goTo('screen-main')" title="Close">‚úï</button>
      </div>
    </div>

    <div class="vc-btn-row">
      <button class="vc-mic-btn" id="micToggle" onclick="document.getElementById('voice-button').click(); toggleMic();">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10a7 7 0 0 0 14 0"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="8" y1="22" x2="16" y2="22"/>
        </svg>
      </button>
      <button class="vc-camera-btn" id="cameraToggle" onclick="toggleCameraVoice()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 7l-7 5 7 5V7z"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>
      </button>
      <button class="vc-close-btn" onclick="stopCameraVoice(); document.getElementById('voice-button').click(); goTo('screen-main');">‚úï</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="micModal">
    <div class="modal">
      <button class="modal-close" onclick="hideModal()">‚úï</button>
      <h3>Microphone access required</h3>
      <p>To use voice mode, you'll need to enable your microphone and try again.</p>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: CHOOSE VOICE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-voice-select">

  <div class="vs-nav">
    <button class="v-icon-btn" onclick="goTo('screen-voice')">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <div class="vs-main">
    <h2 class="vs-title">Choose a voice</h2>

    <div class="vs-avatars">
      <div class="vs-avatar" onclick="selectAvatar(0, this)"></div>
      <div class="vs-avatar" onclick="selectAvatar(1, this)"></div>
      <div class="vs-avatar selected" onclick="selectAvatar(2, this)"></div>
      <div class="vs-avatar" onclick="selectAvatar(3, this)"></div>
    </div>

    <div class="vs-carousel">
      <div class="carousel-side" onclick="prevVoice()">
        <div class="c-name" id="prevVoiceName">Monday</div>
        <div class="c-tag" id="prevVoiceTag">Balanced</div>
      </div>
      <button class="carousel-arrow" onclick="prevVoice()">‚Äπ</button>
      <div class="carousel-center">
        <div class="c-name" id="curVoiceName">Juniper</div>
        <div class="c-tag" id="curVoiceTag">Open and upbeat</div>
      </div>
      <button class="carousel-arrow" onclick="nextVoice()">‚Ä∫</button>
      <div class="carousel-side" onclick="nextVoice()">
        <div class="c-name" id="nextVoiceName">Arbor</div>
        <div class="c-tag" id="nextVoiceTag">Engaging and calming</div>
      </div>
    </div>

    <div class="vs-actions">
      <button class="vs-done-btn" onclick="goTo('screen-voice')">Done</button>
      <button class="vs-cancel-btn" onclick="goTo('screen-voice')">Cancel</button>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  function goTo(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'screen-voice') startOrbAnim();
  }

  // ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
  function showModal() {
    document.getElementById('micModal').classList.add('visible');
  }
  function hideModal() {
    document.getElementById('micModal').classList.remove('visible');
  }
  document.getElementById('micModal').addEventListener('click', function(e) {
    if (e.target === this) hideModal();
  });

  // ‚îÄ‚îÄ MIC TOGGLE ‚îÄ‚îÄ
  let micOn = true;
  function toggleMic() {
    micOn = !micOn;
    const orb = document.getElementById('mainOrb');
    const btn = document.getElementById('micToggle');
    const rings = document.querySelectorAll('.orb-ring');
    if (micOn) {
      orb.className = 'orb listening';
      btn.style.opacity = '1';
      rings.forEach(r => r.style.display = 'block');
    } else {
      orb.className = 'orb';
      btn.style.opacity = '0.4';
      rings.forEach(r => r.style.display = 'none');
    }
  }

  // ‚îÄ‚îÄ ORB ANIMATION ‚îÄ‚îÄ
  function startOrbAnim() {
    const orb = document.getElementById('mainOrb');
    const btn = document.getElementById('micToggle');
    const rings = document.querySelectorAll('.orb-ring');
    orb.className = 'orb listening';
    if (btn) btn.style.opacity = '1';
    rings.forEach(r => r.style.display = 'block');
    micOn = true;
    let t = 0;
    const states = ['listening','speaking','listening'];
    let si = 0;
    clearInterval(window._orbTimer);
    window._orbTimer = setInterval(() => {
      if (!micOn) return;
      si = (si + 1) % states.length;
      orb.className = 'orb ' + states[si];
    }, 2800);
  }

  // ‚îÄ‚îÄ VOICE CAROUSEL ‚îÄ‚îÄ
  const voices = [
    { name: 'Breeze', tag: 'Light and clear' },
    { name: 'Monday', tag: 'Balanced' },
    { name: 'Juniper', tag: 'Open and upbeat' },
    { name: 'Arbor', tag: 'Engaging and calming' },
    { name: 'Sol', tag: 'Warm and direct' },
    { name: 'Ember', tag: 'Deep and steady' },
  ];
  let vi = 2;

  function updateCarousel() {
    const prev = voices[(vi - 1 + voices.length) % voices.length];
    const cur = voices[vi];
    const next = voices[(vi + 1) % voices.length];
    document.getElementById('prevVoiceName').textContent = prev.name;
    document.getElementById('prevVoiceTag').textContent = prev.tag;
    document.getElementById('curVoiceName').textContent = cur.name;
    document.getElementById('curVoiceTag').textContent = cur.tag;
    document.getElementById('nextVoiceName').textContent = next.name;
    document.getElementById('nextVoiceTag').textContent = next.tag;
  }
  function nextVoice() { vi = (vi + 1) % voices.length; updateCarousel(); }
  function prevVoice() { vi = (vi - 1 + voices.length) % voices.length; updateCarousel(); }

  // ‚îÄ‚îÄ SELECT AVATAR ‚îÄ‚îÄ
  function selectAvatar(idx, el) {
    document.querySelectorAll('.vs-avatar').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
  }

  // ‚îÄ‚îÄ NEW SESSION ‚îÄ‚îÄ
  async function startNewSession() {
    const oldSessionId = localStorage.getItem('support_bot_session_id') || 'default';

    // Stop current session
    if (window._agentSocket) {
      window._agentSocket.emit('stop_live_session', { session_id: oldSessionId });
    }

    // Clear stored handle on server
    try {
      await fetch('/api/clear-session-handle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: oldSessionId })
      });
    } catch (e) { console.error('Clear handle error:', e); }

    // Generate new session ID
    const newSessionId = 'session-' + Date.now();
    localStorage.setItem('support_bot_session_id', newSessionId);

    // Restart: click mic to stop, then click again to start fresh
    const micToggle = document.getElementById('micToggle');
    if (micOn) {
      document.getElementById('voice-button').click();
      toggleMic();
    }

    // Brief delay then start new session
    setTimeout(() => {
      document.getElementById('voice-button').click();
      if (!micOn) toggleMic();
    }, 600);
  }

  // ‚îÄ‚îÄ CAMERA IN VOICE MODE ‚îÄ‚îÄ
  let voiceCameraStream = null;
  let voiceCameraInterval = null;
  let voiceCameraProcessing = false;

  function toggleCameraVoice() {
    if (voiceCameraStream) stopCameraVoice();
    else startCameraVoice();
  }

  async function startCameraVoice() {
    try {
      voiceCameraStream = await navigator.mediaDevices.getUserMedia({ video: { width: 768, height: 768 } });
      const videoEl = document.getElementById('voiceCameraVideo');
      videoEl.srcObject = voiceCameraStream;

      // Show video, hide orb
      document.getElementById('videoPreview').classList.add('active');
      document.getElementById('voiceMain').classList.add('camera-active');
      document.getElementById('cameraToggle').classList.add('active');

      // Send frames at 1 FPS
      voiceCameraInterval = setInterval(() => sendVoiceCameraFrame(videoEl), 1000);
    } catch (err) {
      console.error('Camera error:', err);
    }
  }

  function stopCameraVoice() {
    if (voiceCameraInterval) { clearInterval(voiceCameraInterval); voiceCameraInterval = null; }
    if (voiceCameraStream) { voiceCameraStream.getTracks().forEach(t => t.stop()); voiceCameraStream = null; }
    const videoEl = document.getElementById('voiceCameraVideo');
    if (videoEl) videoEl.srcObject = null;

    document.getElementById('videoPreview').classList.remove('active');
    document.getElementById('voiceMain').classList.remove('camera-active');
    document.getElementById('cameraToggle').classList.remove('active');
  }

  function sendVoiceCameraFrame(videoEl) {
    if (!videoEl || !voiceCameraStream || voiceCameraProcessing) return;
    voiceCameraProcessing = true;

    const canvas = document.createElement('canvas');
    canvas.width = 768; canvas.height = 768;
    const ctx = canvas.getContext('2d');
    const ar = videoEl.videoWidth / videoEl.videoHeight;
    let dw = 768, dh = 768, ox = 0, oy = 0;
    if (ar > 1) { dh = 768/ar; oy = (768-dh)/2; } else { dw = 768*ar; ox = (768-dw)/2; }
    ctx.drawImage(videoEl, ox, oy, dw, dh);

    canvas.toBlob((blob) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        // Use the socket from agent.js via the global
        if (window._agentSocket) {
          window._agentSocket.emit('send_camera_frame', {
            session_id: localStorage.getItem('support_bot_session_id') || 'default',
            frame: base64
          });
        }
        setTimeout(() => { voiceCameraProcessing = false; }, 50);
      };
      reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.6);
  }
</script>


<!-- HIDDEN REQUIRED ELEMENTS FOR JS TO INIT -->
<div style="display:none;" id="messages-container"></div>
<textarea style="display:none;" id="user-input"></textarea>
<button style="display:none;" id="send-button"></button>
<button style="display:none;" id="upload-button"></button>
<input style="display:none;" type="file" id="image-upload-input" />
<button style="display:none;" id="camera-button"></button>
<button style="display:none;" id="screen-share-button"></button>
<div style="display:none;" id="camera-container"><video id="camera-video"></video></div>
<input style="display:none;" id="user-name-input" />
<button style="display:none;" id="set-name-btn"></button>
<span style="display:none;" id="current-user-name"></span>
<button style="display:none;" id="clear-all-button"></button>

<div id="notification-toast"></div>
<script type="module">
  import { initGenMediaChat } from '/src/features/agent.js';
  document.addEventListener('DOMContentLoaded', () => {
      initGenMediaChat();
  });
</script>

</body>
</html>
